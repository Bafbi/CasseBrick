<html>
<head>
    <meta charset="utf-8" />
    <title>Gamedev Canvas Workshop</title>
    <style>
    	* { padding: 0; margin: 0; }
    	canvas { background: #F79F97; display: block; margin: 0 auto; }
    </style>
</head>
<body style="background-color:#611612;">

<canvas id="myCanvas" width="480" height="320" style=></canvas>

<script>
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let x = canvas.width/2;
  let y = canvas.height-50;
  let dx = 1;
  let dy = -2;
  const ballRadius = 10;
  let ballColor = "#0095DD"
  let paddleColor = "#0095DD"
  const paddleHeight = 10;
  const paddleWidth = 75;
  let paddleX = (canvas.width-paddleWidth)/2;
  let paddleY = canvas.height-paddleHeight-10
  let rightPressed = false;
  let leftPressed = false;
  let pause = false;
  let interval = setInterval(draw, 10);
  let score = 0;

  const brickRowCount = 5;
  const brickColumnCount = 5;
  const brickWidth = 75;
  const brickHeight = 20;
  const brickPadding = 10;
  const brickOffsetTop = 30;
  const brickOffsetLeft = 30;

  var bricks = [];
  for(let c=0; c<brickColumnCount; c++) {
    bricks[c] = [];
    for(let r=0; r<brickRowCount; r++) {
      bricks[c][r] = { x: 0, y: 0, status: 1 };
    }
  }

  function drawBricks() {
    for(let c=0; c<brickColumnCount; c++) {
        for(let r=0; r<brickRowCount; r++) {
          if (bricks[c][r].status == 1) {
            let brickX = (c*(brickWidth+brickPadding))+brickOffsetLeft;
            let brickY = (r*(brickHeight+brickPadding))+brickOffsetTop;
            bricks[c][r].x = brickX;
            bricks[c][r].y = brickY;
            ctx.beginPath();
            ctx.rect(brickX, brickY, brickWidth, brickHeight);
            ctx.fillStyle = "#0095DD";
            ctx.fill();
            ctx.closePath();
          }

        }
    }
  }

  function bricksCollision() {
    for(var c=0; c<brickColumnCount; c++) {
        for(var r=0; r<brickRowCount; r++) {
          if (bricks[c][r].status == 1) {
            let brick = bricks[c][r];
            if (x + dx > brick.x && x + dx < brick.x+brickWidth && y + dy > brick.y && y + dy < brick.y+brickHeight) {
              brick.status = 0;
              dy = -dy;
              score++;
              if (score == brickRowCount*brickColumnCount) {
                alert(`Vous avez gagnÃ© avec ${score} points, Bravo!`);
                document.location.reload();
                clearInterval(interval);
              }
            }
          }
        }
    }
  }

  function drawScore() {
    ctx.font = "16px Arial";
    ctx.fillStyle = "#0095DD";
    ctx.fillText(`Score : ${score}`, 8, 20);
  }

    function drawBall() {
        ctx.beginPath();
        ctx.arc(x, y, ballRadius, 0, Math.PI*2);
        ctx.fillStyle = ballColor;
        ctx.fill();
        ctx.closePath();
    }

    function drawPaddle() {
      ctx.beginPath();
      ctx.rect(paddleX, paddleY, paddleWidth, paddleHeight);
      ctx.fillStyle = paddleColor;
      ctx.fill();
      ctx.closePath();
    }

    function draw() {
      if (pause == false) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBall();
        drawPaddle();
        drawBricks();
        bricksCollision();
        drawScore();

        x += dx;
        y += dy;

        if (paddleX < (x + dx) && (x + dx) < (paddleX + paddleWidth) && paddleY < (y + dy) && (y + dy) < (paddleY + paddleHeight)) {
          dx *= 1.1;
          dy = -dy * 1.02;
          paddleColor = '#'+(Math.random()*0xFFFFFF<<0).toString(16);
        }
        else if (y + dy - ballRadius < 0) {
          dy = -dy;
          ballColor = '#'+(Math.random()*0xFFFFFF<<0).toString(16);
        }
        else if (x + dx - ballRadius < 0 || x + dx + ballRadius > canvas.width) {
          dx = -dx;
          ballColor = '#'+(Math.random()*0xFFFFFF<<0).toString(16);
        }
        else if (y + dy + ballRadius > canvas.height) {
          alert("GAME OVER");
          document.location.reload();
          clearInterval(interval);
        }

        if(rightPressed && paddleX + paddleWidth < canvas.width) {
          paddleX += 6;
        }
        else if(leftPressed && paddleX > 0) {
          paddleX -= 6;
        }
      }
    }

    document.addEventListener("keydown", keyDownHandler, false);
    document.addEventListener("keyup", keyUpHandler, false);
    document.addEventListener("mousemove", mouseMoveHandler, false);

    function mouseMoveHandler(e) {
    let relativeX = e.offsetX;
    let relativeY = e.offsetY;
    if(relativeX > 0 && relativeX < canvas.width && relativeY > 0 && relativeY < canvas.height) {
      paddleX = relativeX - paddleWidth/2;
      }
    }

    function keyDownHandler(e) {
      if(e.key == "Right" || e.key == "ArrowRight" || e.key == "d") {
          rightPressed = true;
      }
      else if(e.key == "Left" || e.key == "ArrowLeft" || e.key == "q") {
          leftPressed = true;
      }
      else if(e.key == "p" && pause == false) {
        pause = true
      }
      else if(e.key == "p" && pause == true) {
        pause = false
      }
    }

    function keyUpHandler(e) {
        if(e.key == "Right" || e.key == "ArrowRight" || e.key == "d") {
            rightPressed = false;
        }
        else if(e.key == "Left" || e.key == "ArrowLeft" || e.key == "q") {
            leftPressed = false;
        }
    }
</script>

</body>
</html>
